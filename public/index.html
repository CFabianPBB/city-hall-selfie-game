<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>City Hall Selfie - The Game! | ELGL 10th Anniversary</title>
    
    <!-- NO API KEY HERE - Will be loaded dynamically -->
    
    <!-- SimCity-style Font -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: #4a90e2;
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            position: fixed;
            -webkit-overflow-scrolling: touch;
        }

        /* Mobile-first responsive design */
        @media (max-width: 768px) {
            /* Start screen mobile adjustments */
            .start-container {
                max-width: 95%;
                padding: 15px;
                margin: 5px;
                max-height: 95vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .game-title {
                font-size: 16px;
                line-height: 1.3;
            }

            /* Game container mobile */
            #gameContainer {
                touch-action: pan-x pan-y;
                position: relative;
                height: 100vh;
                width: 100vw;
            }

            /* Google Map mobile */
            #googleMap {
                touch-action: pan-x pan-y pinch-zoom;
                height: 100%;
                width: 100%;
            }

            /* Hide avatar on mobile to reduce clutter */
            #avatar {
                display: none;
            }

            /* Score display mobile - compact top left */
            .score-display {
                position: fixed;
                top: 10px;
                left: 10px;
                padding: 8px 12px;
                font-size: 10px;
                background: rgba(0, 0, 0, 0.85);
                border-radius: 8px;
                color: white;
                z-index: 300;
                border: 2px solid #f1c40f;
                min-width: 80px;
            }

            .score-label {
                font-size: 10px;
                margin-bottom: 2px;
            }

            .score-value {
                font-size: 18px;
                font-family: 'Press Start 2P', cursive;
                color: #f1c40f;
            }

            /* Hide instructions completely on mobile */
            .instructions-toggle {
                display: none;
            }

            .instructions {
                display: none !important;
            }

            /* Leaderboard mobile - much smaller and positioned better */
            .leaderboard {
                position: fixed;
                top: 10px;
                right: 10px;
                width: 140px;
                max-height: 120px;
                padding: 8px;
                background: rgba(255, 255, 255, 0.95);
                font-size: 9px;
                border-radius: 8px;
                z-index: 300;
                border: 2px solid #2c3e50;
                overflow-y: auto;
            }

            .leaderboard h3 {
                font-size: 10px;
                margin-bottom: 6px;
                text-align: center;
                font-family: 'Press Start 2P', cursive;
            }

            .leaderboard-entry {
                padding: 3px;
                margin-bottom: 2px;
                font-size: 8px;
                border-radius: 3px;
            }

            .rank {
                font-size: 9px;
                width: 15px;
                font-family: 'Press Start 2P', cursive;
            }

            .player-name {
                font-size: 8px;
                max-width: 60px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .player-score {
                font-size: 9px;
                font-family: 'Press Start 2P', cursive;
            }

            /* Control panel mobile - bottom of screen, more compact */
            .control-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 12px 8px;
                transform: none;
                background: rgba(255, 255, 255, 0.95);
                border-radius: 12px 12px 0 0;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
                z-index: 300;
                border-top: 3px solid #2c3e50;
            }

            .search-box {
                flex-direction: row;
                gap: 8px;
                align-items: center;
            }

            .search-box input {
                flex: 1;
                font-size: 14px;
                padding: 10px;
                border: 2px solid #2c3e50;
                border-radius: 6px;
            }

            .go-btn {
                width: auto;
                padding: 10px 16px;
                font-size: 10px;
                font-family: 'Press Start 2P', cursive;
                white-space: nowrap;
            }

            /* Influencer counter mobile - top center */
            .influencer-counter {
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                padding: 6px 10px;
                font-size: 9px;
                background: rgba(155, 89, 182, 0.95);
                border-radius: 8px;
                z-index: 300;
                border: 2px solid #8e44ad;
                color: white;
                text-align: center;
                min-width: 100px;
            }

            .influencer-counter-value {
                font-size: 16px;
                font-family: 'Press Start 2P', cursive;
                color: #f1c40f;
                display: block;
            }

            .influencer-counter-label {
                font-size: 8px;
                display: block;
                margin-bottom: 2px;
            }

            .influencer-counter-total {
                font-size: 8px;
                display: block;
                margin-top: 2px;
            }

            /* Community reel - hide on mobile */
            .community-reel {
                display: none;
            }

            /* My selfies button mobile - bottom left corner */
            .my-selfies-btn {
                position: fixed;
                bottom: 80px;
                left: 10px;
                padding: 8px 12px;
                font-size: 9px;
                background: rgba(155, 89, 182, 0.95);
                color: white;
                border: 2px solid #8e44ad;
                border-radius: 6px;
                font-family: 'Press Start 2P', cursive;
                z-index: 300;
                cursor: pointer;
            }

            /* Influencer avatars on mobile - bigger and more spaced */
            .influencer-avatar {
                width: 50px;
                height: 65px;
                z-index: 250;
            }

            .influencer-head {
                width: 40px;
                height: 40px;
                font-size: 12px;
                border: 3px solid white;
            }

            .influencer-body {
                width: 30px;
                height: 25px;
            }

            /* Logo queue mobile - hide to reduce clutter */
            .logo-queue {
                display: none;
            }

            /* Modals mobile */
            .selfie-content {
                max-width: 95%;
                padding: 15px;
                margin: 10px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .selfie-preview {
                width: 100%;
                max-width: 300px;
                height: 200px;
            }

            .selfie-title {
                font-size: 14px;
            }

            .modal-btn {
                padding: 8px 12px;
                font-size: 9px;
                margin: 5px;
            }

            /* Gallery modal mobile */
            .gallery-content {
                padding: 15px;
                margin: 10px;
                max-height: 90vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .selfies-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 8px;
            }

            /* Influencer modal mobile */
            .influencer-modal {
                padding: 15px;
                max-width: 90%;
                border-radius: 10px;
            }

            .influencer-modal h2 {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .influencer-modal .influencer-name {
                font-size: 16px;
                margin: 8px 0;
            }

            .influencer-modal .points-earned {
                font-size: 12px;
                padding: 8px 12px;
                margin: 10px 0;
            }

            .influencer-modal button {
                padding: 8px 16px;
                font-size: 9px;
            }
        }

        /* Desktop styles remain the same but with better organization */
        @media (min-width: 769px) {
            .score-display {
                position: absolute;
                top: 20px;
                left: 20px;
                background: linear-gradient(145deg, #2c3e50, #34495e);
                padding: 20px;
                border-radius: 5px;
                box-shadow: 
                    0 0 0 2px #000,
                    0 5px 20px rgba(0,0,0,0.5);
                z-index: 200;
                border: 2px solid #1a252f;
                color: white;
            }

            .leaderboard {
                position: absolute;
                top: 20px;
                right: 20px;
                background: linear-gradient(145deg, #ecf0f1, #bdc3c7);
                padding: 20px;
                border-radius: 5px;
                box-shadow: 
                    0 0 0 2px #000,
                    0 5px 30px rgba(0,0,0,0.5);
                width: 300px;
                max-height: 400px;
                overflow-y: auto;
                z-index: 200;
                border: 3px solid #2c3e50;
            }

            .influencer-counter {
                position: absolute;
                top: 20px;
                right: 340px;
                background: linear-gradient(145deg, #9b59b6, #8e44ad);
                padding: 15px;
                border-radius: 5px;
                box-shadow: 0 0 0 2px #000, 0 5px 20px rgba(0,0,0,0.5);
                z-index: 200;
                color: white;
                text-align: center;
            }

            .control-panel {
                position: absolute;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(145deg, #ecf0f1, #bdc3c7);
                padding: 20px;
                border-radius: 5px;
                box-shadow: 
                    0 0 0 2px #000,
                    0 5px 30px rgba(0,0,0,0.5);
                z-index: 200;
                border: 3px solid #2c3e50;
            }
        }

        /* iOS-specific fixes */
        @supports (-webkit-touch-callout: none) {
            #gameContainer {
                position: fixed;
                height: 100vh;
                height: -webkit-fill-available;
            }

            .start-container {
                -webkit-overflow-scrolling: touch;
                overflow-y: scroll;
            }

            .selfie-modal, .selfies-gallery-modal {
                -webkit-overflow-scrolling: touch;
                overflow-y: auto;
            }
        }

        /* Start Screen with SimCity Style */
        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #startScreen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0,0,0,0.1) 2px,
                    rgba(0,0,0,0.1) 4px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 2px,
                    rgba(0,0,0,0.1) 2px,
                    rgba(0,0,0,0.1) 4px
                );
            opacity: 0.3;
        }

        .start-container {
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 
                0 0 0 3px #333,
                0 0 0 6px #666,
                0 20px 60px rgba(0,0,0,0.5);
            max-width: 600px;
            width: 90%;
            text-align: center;
            position: relative;
            z-index: 1;
            border: 2px solid #000;
        }

        .simcity-header {
            background: linear-gradient(180deg, #0066CC 0%, #004499 100%);
            color: white;
            padding: 15px;
            margin: -40px -40px 20px -40px;
            border-radius: 8px 8px 0 0;
            border-bottom: 3px solid #000;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .elgl-logo {
            width: 200px;
            height: auto;
            margin: 20px auto;
            display: block;
        }

        .game-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 24px;
            color: #2c3e50;
            margin: 20px 0;
            text-shadow: 
                2px 2px 0px #4a90e2,
                4px 4px 0px rgba(0,0,0,0.2);
            line-height: 1.5;
        }

        .anniversary-badge {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: inline-block;
            margin: 10px 0 20px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            border: 2px solid #196F3D;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #2c3e50;
            border-radius: 5px;
            font-size: 16px;
            font-family: 'Orbitron', sans-serif;
            background: #f8f9fa;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .file-upload label {
            display: block;
            padding: 15px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: 2px solid #000;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .file-upload label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .start-btn {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: 3px solid #000;
            padding: 15px 40px;
            font-size: 16px;
            font-family: 'Press Start 2P', cursive;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
            box-shadow: 
                3px 3px 0px #000,
                6px 6px 0px rgba(0,0,0,0.2);
        }

        .start-btn:hover:not(:disabled) {
            transform: translate(-2px, -2px);
            box-shadow: 
                5px 5px 0px #000,
                8px 8px 0px rgba(0,0,0,0.2);
        }

        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Game Container */
        #gameContainer {
            display: none;
            position: relative;
            width: 100%;
            height: 100vh;
        }

        /* Google Maps Integration */
        #googleMap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Avatar Overlay - Make sure it's visible */
        #avatar {
            position: absolute;
            width: 80px;
            height: 100px;
            z-index: 150;
            pointer-events: none;
            transition: all 2s ease;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #avatar.walking {
            animation: walk 0.5s infinite;
        }

        @keyframes walk {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .avatar-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .avatar-head {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            margin: 0 auto;
            border: 3px solid white;
            box-shadow: 0 3px 15px rgba(0,0,0,0.5);
            position: relative;
            z-index: 2;
        }

        .avatar-body {
            width: 45px;
            height: 50px;
            background: linear-gradient(180deg, #3498db 0%, #2980b9 100%);
            margin: -15px auto 0;
            border-radius: 20px 20px 10px 10px;
            position: relative;
            border: 2px solid #1e5f8e;
        }

        .avatar-arms {
            position: absolute;
            width: 70px;
            height: 8px;
            background: #3498db;
            top: 10px;
            left: -12px;
            border-radius: 4px;
            border: 2px solid #1e5f8e;
        }

        .avatar-legs {
            position: absolute;
            bottom: -25px;
            left: 12px;
            width: 20px;
            height: 25px;
        }

        .avatar-legs::before,
        .avatar-legs::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 25px;
            background: #2c3e50;
            border-radius: 0 0 5px 5px;
            border: 1px solid #1a252f;
        }

        .avatar-legs::before { left: 0; }
        .avatar-legs::after { right: 0; }

        /* Search Box Styles */
        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box input {
            padding: 12px;
            border: 2px solid #2c3e50;
            border-radius: 5px;
            font-size: 14px;
            width: 350px;
            font-family: 'Orbitron', sans-serif;
            background: white;
        }

        .go-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: 2px solid #000;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Press Start 2P', cursive;
            transition: all 0.3s;
            box-shadow: 
                2px 2px 0px #000;
        }

        .go-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 
                3px 3px 0px #000;
        }

        /* Score Display Styles */
        .score-label {
            font-size: 12px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #95a5a6;
        }

        .score-value {
            font-size: 36px;
            font-weight: bold;
            font-family: 'Press Start 2P', cursive;
            color: #f1c40f;
            text-shadow: 2px 2px 0px #000;
        }

        /* Leaderboard Styles */
        .leaderboard h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            text-transform: uppercase;
        }

        .leaderboard-entry {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border: 2px solid #2c3e50;
            border-radius: 5px;
            transition: all 0.3s;
            font-family: 'Orbitron', sans-serif;
        }

        .leaderboard-entry:hover {
            background: #f1c40f;
            transform: translateX(5px);
        }

        .leaderboard-entry.gold {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            border-color: #d68910;
        }

        .leaderboard-entry.silver {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            border-color: #566573;
        }

        .leaderboard-entry.bronze {
            background: linear-gradient(135deg, #e67e22, #d35400);
            border-color: #a04000;
        }

        .rank {
            font-weight: bold;
            color: #2c3e50;
            margin-right: 15px;
            font-size: 16px;
            width: 35px;
            font-family: 'Press Start 2P', cursive;
        }

        .player-name {
            flex-grow: 1;
            font-weight: 600;
            color: #2c3e50;
        }

        .player-score {
            font-weight: bold;
            color: #27ae60;
            font-size: 18px;
            font-family: 'Press Start 2P', cursive;
        }

        /* Influencer Counter Styles */
        .influencer-counter-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .influencer-counter-value {
            font-family: 'Press Start 2P', cursive;
            font-size: 20px;
            color: #f1c40f;
            text-shadow: 2px 2px 0px #000;
        }

        .influencer-counter-total {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.8;
        }

        /* Logo Queue */
        .logo-queue {
            position: absolute;
            bottom: 100px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 200;
        }

        .logo-item {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 
                0 0 0 2px #000,
                0 3px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bounceIn 0.5s ease;
            font-weight: bold;
            border: 2px solid #2c3e50;
        }

        @keyframes bounceIn {
            0% { transform: scale(0) rotate(180deg); }
            60% { transform: scale(1.2) rotate(-10deg); }
            100% { transform: scale(1) rotate(0); }
        }

        .logo-item.tyler {
            background: linear-gradient(135deg, #0066CC, #004499);
            color: white;
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
        }

        .logo-item.resourcex {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
        }

        /* Selfie Modal */
        .selfie-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .selfie-modal.show {
            display: flex;
        }

        .selfie-content {
            background: linear-gradient(145deg, #ecf0f1, #ffffff);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 700px;
            animation: zoomIn 0.3s ease;
            box-shadow: 
                0 0 0 3px #000,
                0 20px 60px rgba(0,0,0,0.5);
            border: 3px solid #2c3e50;
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .selfie-title {
            color: #2c3e50;
            margin-bottom: 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 18px;
            text-transform: uppercase;
        }

        .selfie-preview {
            position: relative;
            width: 600px;
            height: 400px;
            margin: 20px auto;
            border: 5px solid #2c3e50;
            border-radius: 5px;
            overflow: hidden;
            background: #333;
            box-shadow: 
                0 0 0 2px #000,
                0 10px 30px rgba(0,0,0,0.5);
        }

        .selfie-background {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .selfie-person {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 180px;
            filter: drop-shadow(0 5px 20px rgba(0,0,0,0.5));
        }

        .selfie-person-head {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            margin: 0 auto;
            border: 4px solid white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .selfie-person-body {
            width: 70px;
            height: 80px;
            background: linear-gradient(180deg, #3498db, #2980b9);
            margin: -25px auto 0;
            border-radius: 30px 30px 10px 10px;
            border: 3px solid #1e5f8e;
        }

        /* ELGL Watermark */
        .elgl-watermark {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 150px;
            height: auto;
            opacity: 0.9;
            filter: drop-shadow(0 2px 10px rgba(0,0,0,0.5));
        }

        .selfie-date {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            color: #2c3e50;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 25px;
            border: 2px solid #000;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Press Start 2P', cursive;
            transition: all 0.3s;
            text-transform: uppercase;
            box-shadow: 2px 2px 0px #000;
        }

        .modal-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0px #000;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .modal-btn.secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .modal-btn.linkedin {
            background: #0077b5;
            color: white;
        }

        /* Points Popup */
        .points-popup {
            position: absolute;
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            color: #2c3e50;
            padding: 15px 25px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 20px;
            font-family: 'Press Start 2P', cursive;
            z-index: 500;
            animation: floatUp 2s ease forwards;
            pointer-events: none;
            box-shadow: 
                0 0 0 2px #000,
                0 5px 20px rgba(241, 196, 15, 0.5);
            border: 2px solid #d68910;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(0);
                opacity: 1;
            }
            50% {
                transform: translateY(-80px) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateY(-150px) scale(0.8);
                opacity: 0;
            }
        }

        /* Instructions Panel */
        .instructions {
            position: absolute;
            top: 120px;
            left: 20px;
            background: linear-gradient(145deg, #34495e, #2c3e50);
            padding: 20px;
            border-radius: 5px;
            max-width: 280px;
            z-index: 200;
            box-shadow: 
                0 0 0 2px #000,
                0 5px 20px rgba(0,0,0,0.5);
            border: 2px solid #1a252f;
            color: white;
        }

        .instructions h4 {
            color: #f1c40f;
            margin-bottom: 15px;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            text-transform: uppercase;
        }

        .instructions ul {
            list-style: none;
            padding: 0;
        }

        .instructions li {
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
            font-size: 14px;
            line-height: 1.4;
        }

        .instructions li::before {
            content: 'â–¶';
            position: absolute;
            left: 0;
            color: #f1c40f;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #34495e;
            border-top: 5px solid #f1c40f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            text-transform: uppercase;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Influencer Avatars - More Visible! */
        .influencer-avatar {
            position: absolute;
            width: 50px;
            height: 65px;
            z-index: 75;
            cursor: pointer;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));
        }

        .influencer-avatar:hover {
            transform: scale(1.3);
            z-index: 100;
        }

        .influencer-head {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            color: white;
            font-weight: bold;
            box-shadow: 0 3px 15px rgba(0,0,0,0.5);
            border: 3px solid white;
            position: relative;
            animation: bob 3s ease-in-out infinite;
        }

        @keyframes bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .influencer-head::after {
            content: 'âœ¨';
            position: absolute;
            top: -12px;
            right: -8px;
            font-size: 16px;
            animation: sparkle 2s infinite;
        }

        @keyframes sparkle {
            0%, 100% { 
                opacity: 0;
                transform: scale(0.8);
            }
            50% { 
                opacity: 1;
                transform: scale(1.2);
            }
        }

        .influencer-body {
            width: 30px;
            height: 25px;
            background: linear-gradient(180deg, #2c3e50, #34495e);
            margin: -8px auto 0;
            border-radius: 10px 10px 5px 5px;
            border: 2px solid #1a252f;
        }

        /* Influencer Found Modal */
        .influencer-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 0 3px #000, 0 20px 60px rgba(0,0,0,0.5);
            z-index: 2001;
            text-align: center;
            animation: bounceIn 0.5s ease;
        }

        .influencer-modal.show {
            display: block;
        }

        .influencer-modal h2 {
            color: #27ae60;
            font-family: 'Press Start 2P', cursive;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .influencer-modal .influencer-name {
            color: #2c3e50;
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0;
        }

        .influencer-modal .influencer-location {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .influencer-modal .points-earned {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            color: #2c3e50;
            padding: 10px 20px;
            border-radius: 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
            display: inline-block;
            margin: 15px 0;
        }

        .influencer-modal button {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: 2px solid #000;
            padding: 10px 25px;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }

        /* Bounce out animation */
        @keyframes bounceOut {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(0); opacity: 0; }
        }

        /* Fall animation for confetti */
        @keyframes fall {
            to {
                transform: translateY(110vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* My Selfies Button */
        .my-selfies-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: 2px solid #000;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            transition: all 0.3s;
            text-transform: uppercase;
            box-shadow: 2px 2px 0px #000;
        }

        .my-selfies-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0px #000;
        }

        /* Gallery Modal */
        .selfies-gallery-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .selfies-gallery-modal.show {
            display: flex;
        }

        .gallery-content {
            background: linear-gradient(145deg, #ecf0f1, #ffffff);
            padding: 30px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 
                0 0 0 3px #000,
                0 20px 60px rgba(0,0,0,0.5);
            border: 3px solid #2c3e50;
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .gallery-title {
            color: #2c3e50;
            font-family: 'Press Start 2P', cursive;
            font-size: 18px;
        }

        .close-gallery {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: 2px solid #000;
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .selfies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .selfie-item {
            border: 3px solid #2c3e50;
            border-radius: 5px;
            overflow: hidden;
            background: white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .selfie-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .selfie-item-info {
            padding: 10px;
            text-align: center;
            color: #2c3e50;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div id="startScreen">
        <div class="start-container">
            <div class="simcity-header">City Hall Selfie Game - Menu</div>
            
            <!-- ELGL Logo Placeholder -->
            <svg class="elgl-logo" viewBox="0 0 200 250" xmlns="http://www.w3.org/2000/svg">
                <rect x="50" y="50" width="100" height="120" fill="#27ae60" stroke="#000" stroke-width="3"/>
                <polygon points="50,50 100,20 150,50" fill="#229954" stroke="#000" stroke-width="3"/>
                <circle cx="100" cy="90" r="15" fill="#fff"/>
                <text x="100" y="140" text-anchor="middle" font-family="Press Start 2P" font-size="16" fill="#fff">ELGL</text>
                <rect x="30" y="180" width="140" height="50" fill="#27ae60" stroke="#000" stroke-width="2"/>
                <text x="100" y="195" text-anchor="middle" font-family="Arial" font-size="10" font-weight="bold" fill="#fff">10TH ANNIVERSARY</text>
                <text x="100" y="210" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold" fill="#fff">CITY HALL</text>
                <text x="100" y="225" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold" fill="#fff">SELFIE DAY</text>
            </svg>
            
            <h1 class="game-title">City Hall<br>Selfie Game</h1>
            <div class="anniversary-badge">ðŸŽ‰ August 12 - ELGL's 10th Anniversary ðŸŽ‰</div>
            
            <form id="startForm" onsubmit="startGame(event)">
                <div class="form-group">
                    <label for="playerName">Player Name:</label>
                    <input type="text" id="playerName" required placeholder="Enter your name">
                </div>
                
                <div class="form-group">
                    <label for="playerEmail">Email Address:</label>
                    <input type="email" id="playerEmail" required placeholder="Enter your email">
                </div>
                
                <div class="form-group">
                    <label>Avatar Photo:</label>
                    <div class="file-upload">
                        <input type="file" id="photoUpload" accept="image/*" required onchange="handlePhotoUpload(event)" style="display: none;">
                        <label for="photoUpload" id="photoLabel">
                            ðŸ“¸ Upload Photo
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="start-btn" id="startBtn" disabled>Start Game</button>
            </form>
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer">
        <!-- Google Map -->
        <div id="googleMap"></div>
        
        <!-- Avatar -->
        <div id="avatar">
            <div class="avatar-container">
                <div class="avatar-head" id="avatarHead"></div>
                <div class="avatar-body">
                    <div class="avatar-arms"></div>
                    <div class="avatar-legs"></div>
                </div>
            </div>
        </div>

        <!-- Score Display -->
        <div class="score-display">
            <div class="score-label">Score:</div>
            <div class="score-value" id="scoreValue">0</div>
        </div>

        <!-- Instructions Toggle -->
        <button class="instructions-toggle" onclick="toggleInstructions()" style="display: none;">HELP</button>

        <!-- Instructions -->
        <div class="instructions" id="instructionsPanel" style="display: none;">
            <h4>How to Play</h4>
            <ul>
                <li>Search for any city worldwide</li>
                <li>Take selfies at City Halls</li>
                <li>Discover bonus cities for extra points!</li>
            </ul>
        </div>

        <!-- Influencer Counter -->
        <div class="influencer-counter">
            <div class="influencer-counter-label">Influencers Found</div>
            <div class="influencer-counter-value" id="influencerCount">0</div>
            <div class="influencer-counter-total">of 105</div>
        </div>

        <!-- Leaderboard -->
        <div class="leaderboard">
            <h3>Top Players</h3>
            <div id="leaderboardList">
                <div class="leaderboard-entry">
                    <span class="rank">1</span>
                    <span class="player-name">Waiting...</span>
                    <span class="player-score">0</span>
                </div>
            </div>
        </div>

        <!-- Logo Queue -->
        <div class="logo-queue" id="logoQueue"></div>

        <!-- My Selfies Button -->
        <button class="my-selfies-btn" onclick="showMySelfies()">My Selfies</button>

        <!-- Community Reel -->
        <div class="community-reel" style="display: none;">
            <div class="reel-title">Community Selfies</div>
            <div class="reel-container" id="communityReel">
                <div class="reel-empty">Be the first to take a selfie!</div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="search-box">
                <input type="text" id="locationSearch" placeholder="Enter city name (e.g., Denver, Paris, Tokyo)">
                <button class="go-btn" onclick="searchLocation()">GO!</button>
            </div>
        </div>
    </div>

    <!-- Selfie Modal -->
    <div class="selfie-modal" id="selfieModal">
        <div class="selfie-content">
            <h2 class="selfie-title">City Hall Selfie!</h2>
            <div class="selfie-preview">
                <div class="selfie-background" id="selfieBackground">
                    <div class="selfie-person" id="selfiePerson">
                        <div class="selfie-person-head" id="selfiePersonHead"></div>
                        <div class="selfie-person-body"></div>
                    </div>
                    
                    <!-- ELGL Watermark -->
                    <svg class="elgl-watermark" viewBox="0 0 200 250" xmlns="http://www.w3.org/2000/svg">
                        <rect x="0" y="0" width="200" height="250" fill="rgba(255,255,255,0.9)" rx="10"/>
                        <rect x="50" y="40" width="100" height="120" fill="#27ae60"/>
                        <polygon points="50,40 100,10 150,40" fill="#229954"/>
                        <text x="100" y="90" text-anchor="middle" font-family="Arial" font-size="24" font-weight="bold" fill="#fff">ELGL</text>
                        <text x="100" y="120" text-anchor="middle" font-family="Arial" font-size="12" fill="#fff">CITY HALL</text>
                        <text x="100" y="140" text-anchor="middle" font-family="Arial" font-size="12" fill="#fff">SELFIE DAY</text>
                        <text x="100" y="180" text-anchor="middle" font-family="Arial" font-size="16" font-weight="bold" fill="#27ae60">AUG 12</text>
                        <text x="100" y="200" text-anchor="middle" font-family="Arial" font-size="10" fill="#666">10th Anniversary</text>
                    </svg>
                    
                    <div class="selfie-date">AUGUST 12, 2024</div>
                </div>
            </div>
            <p id="locationName" style="font-size: 16px; color: #2c3e50; margin: 15px 0; font-family: 'Orbitron', sans-serif; font-weight: bold;"></p>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="takeSelfie()">SNAP!</button>
                <button class="modal-btn linkedin" onclick="shareToLinkedIn()">SHARE</button>
                <button class="modal-btn secondary" onclick="closeSelfieModal()">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading City Hall...</div>
        </div>
    </div>

    <!-- Influencer Found Modal -->
    <div class="influencer-modal" id="influencerModal">
        <h2>ðŸŒŸ INFLUENCER FOUND! ðŸŒŸ</h2>
        <div class="influencer-name" id="influencerName"></div>
        <div class="influencer-location" id="influencerLocation"></div>
        <div class="points-earned">+15 POINTS!</div>
        <div style="margin: 15px 0; color: #7f8c8d; font-size: 13px;">
            ELGL Local Government Leader
        </div>
        <button onclick="closeInfluencerModal()">AWESOME!</button>
    </div>

    <!-- Selfies Gallery Modal -->
    <div class="selfies-gallery-modal" id="selfiesGallery">
        <div class="gallery-content">
            <div class="gallery-header">
                <h2 class="gallery-title">My City Hall Selfies</h2>
                <button class="close-gallery" onclick="closeSelfiesGallery()">CLOSE</button>
            </div>
            <div class="selfies-grid" id="selfiesGrid"></div>
        </div>
    </div>

    <!-- Background Music -->
    <audio id="bgMusic" loop>
        <source src="data:audio/mpeg;base64,SUQzAwAAAAAAIVRYWFgAAAANAAAAU29mdHdhcmUAR2FyYWdlQmFuZABUWFhYAAAADwAAAGNvbW1lbnQAQ29tbWVudAD/80DEAAAAA0gAAAAATEFNRTMuOTlyAQAB">
    </audio>

    <script>
        // Game State
        let gameState = {
            playerId: null,
            playerName: '',
            playerEmail: '',
            playerPhoto: null,
            score: 0,
            currentCity: null,
            currentLocation: null,
            logos: [],
            isMoving: false,
            map: null,
            markers: [],
            geocoder: null,
            placesService: null,
            googleMapsLoaded: false,
            influencersFound: [],
            influencersOnMap: [],
            mySelfies: [],
            communitySelfies: []
        };

        // ELGL Influencers Database - 105 Amazing Local Gov Leaders!
        const elglInfluencers = [
            { name: "Kirsten Wyatt", location: "West Linn, OR", initials: "KW", color: "#FF6B6B" },
            { name: "Kent Wyatt", location: "Tigard, OR", initials: "KW", color: "#4ECDC4" },
            { name: "Ben Kittelson", location: "Durham, NC", initials: "BK", color: "#45B7D1" },
            { name: "Michael Montgomery", location: "Colorado Springs, CO", initials: "MM", color: "#96CEB4" },
            { name: "Meredith Reynolds", location: "Long Beach, CA", initials: "MR", color: "#FFEAA7" },
            { name: "Mike Ekey", location: "Belton, MO", initials: "ME", color: "#DDA0DD" },
            { name: "Cassie Johnson", location: "Scottsdale, AZ", initials: "CJ", color: "#98D8C8" },
            { name: "Jackie Wehmeyer", location: "Parkland, FL", initials: "JW", color: "#FFB6C1" },
            { name: "Matthew Bajor", location: "Algonquin, IL", initials: "MB", color: "#87CEEB" },
            { name: "Matt Horn", location: "Geneva, NY", initials: "MH", color: "#F4A460" },
            { name: "Nathan Hellyer", location: "Mesa, AZ", initials: "NH", color: "#9370DB" },
            { name: "Sarah Hazel", location: "San Rafael, CA", initials: "SH", color: "#20B2AA" },
            { name: "Kendra Davis", location: "Princeton, NJ", initials: "KD", color: "#FF69B4" },
            { name: "Jasmine Lewis", location: "Chicago, IL", initials: "JL", color: "#00CED1" },
            { name: "Brittany Howard", location: "Fort Worth, TX", initials: "BH", color: "#FF1493" },
            { name: "Katie Babits", location: "Gainesville, FL", initials: "KB", color: "#32CD32" },
            { name: "Rafael Baptista", location: "West Hollywood, CA", initials: "RB", color: "#FFD700" },
            { name: "Kelly Brenna", location: "Durham, NC", initials: "KB", color: "#FF4500" },
            { name: "Laura Kushner", location: "Kalamazoo, MI", initials: "LK", color: "#DA70D6" },
            { name: "Kent Bull", location: "Camas, WA", initials: "KB", color: "#00FA9A" },
            { name: "Zac Horton", location: "Yukon, OK", initials: "ZH", color: "#1E90FF" },
            { name: "Megan George", location: "Topeka, KS", initials: "MG", color: "#FF6347" },
            { name: "Rachel Pinkus", location: "Surprise, AZ", initials: "RP", color: "#40E0D0" },
            { name: "Phillip Messina", location: "Tualatin, OR", initials: "PM", color: "#EE82EE" },
            { name: "Josh Schoemann", location: "Washington County, WI", initials: "JS", color: "#F0E68C" },
            { name: "Ashley Jacobs", location: "Rock Hill, SC", initials: "AJ", color: "#90EE90" },
            { name: "Mallory Roberts", location: "Arlington, VA", initials: "MR", color: "#FFB6C1" },
            { name: "Ellen Fortin", location: "Laramie, WY", initials: "EF", color: "#FFA07A" },
            { name: "Courtney Barwick", location: "Seattle, WA", initials: "CB", color: "#20B2AA" },
            { name: "Katie Carley", location: "Muskegon, MI", initials: "KC", color: "#778899" },
            { name: "Kylie Gemmell", location: "Buda, TX", initials: "KG", color: "#B0C4DE" },
            { name: "Chris Fabian", location: "Thornton, CO", initials: "CF", color: "#FFD700" }, // YOU! Special color!
            { name: "Felicia Johnson", location: "Hayward, CA", initials: "FJ", color: "#FF69B4" },
            { name: "Elizabeth Dragon", location: "Keene, NH", initials: "ED", color: "#8A2BE2" },
            { name: "Jason Yarbrough", location: "Columbia, SC", initials: "JY", color: "#A52A2A" },
            { name: "Danielle Dahl", location: "Minneota, MN", initials: "DD", color: "#5F9EA0" },
            { name: "Bill Brawley", location: "Salisbury, NC", initials: "BB", color: "#D2691E" },
            { name: "Nathan Shueth", location: "Castle Rock, CO", initials: "NS", color: "#FF7F50" },
            { name: "Amanda Jarosz", location: "Mesa, AZ", initials: "AJ", color: "#6495ED" },
            { name: "Celia Kupersmith", location: "San Francisco, CA", initials: "CK", color: "#DC143C" },
            { name: "Gwendolyn Kelso", location: "Colorado Springs, CO", initials: "GK", color: "#00FFFF" },
            { name: "Rachel Scroggins", location: "Olathe, KS", initials: "RS", color: "#32CD32" },
            { name: "Jessica Stephens", location: "Frisco, TX", initials: "JS", color: "#008B8B" },
            { name: "Mariann Oshana", location: "Tigard, OR", initials: "MO", color: "#B8860B" },
            { name: "Jesse Kocher", location: "Jefferson County, CO", initials: "JK", color: "#A9A9A9" },
            { name: "Olivia Hunsaker", location: "Golden, CO", initials: "OH", color: "#BDB76B" },
            { name: "Jay Anderson", location: "Portland, OR", initials: "JA", color: "#8B008B" },
            { name: "Abby Owens", location: "Gresham, OR", initials: "AO", color: "#556B2F" },
            { name: "Bonnie Roberts", location: "Olathe, KS", initials: "BR", color: "#FF8C00" },
            { name: "Ranjit Singh", location: "Irving, TX", initials: "RS", color: "#9932CC" },
            { name: "Emily Touhey", location: "Waltham, MA", initials: "ET", color: "#8B0000" },
            { name: "Emily Pettit", location: "Arlington, VA", initials: "EP", color: "#E9967A" },
            { name: "David Gassaway", location: "Winston-Salem, NC", initials: "DG", color: "#8FBC8F" },
            { name: "Jamie Garrett", location: "Portland, OR", initials: "JG", color: "#483D8B" },
            { name: "Randi Fannon", location: "Durham, NC", initials: "RF", color: "#2F4F4F" },
            { name: "Michele Serrao", location: "West Orange, NJ", initials: "MS", color: "#00CED1" },
            { name: "Tamara Dixon", location: "Clearwater, FL", initials: "TD", color: "#9400D3" },
            { name: "Danielle Marrone", location: "Bellevue, WA", initials: "DM", color: "#FF1493" },
            { name: "Amie Kolesar", location: "Independence, MO", initials: "AK", color: "#00BFFF" },
            { name: "Monica McClain", location: "Richmond, CA", initials: "MM", color: "#696969" },
            { name: "Sarah Swanson", location: "Greenwood Village, CO", initials: "SS", color: "#1E90FF" },
            { name: "Nicholas Brown", location: "Katy, TX", initials: "NB", color: "#B22222" },
            { name: "Nai'a Newlight", location: "Anchorage, AK", initials: "NN", color: "#228B22" },
            { name: "Melissa Higbee", location: "Jefferson County, CO", initials: "MH", color: "#FF00FF" },
            { name: "Matt Nelson", location: "Ramsey County, MN", initials: "MN", color: "#FFD700" },
            { name: "Alex Rice", location: "Flower Mound, TX", initials: "AR", color: "#DAA520" },
            { name: "JR Hamilton", location: "Vancouver, WA", initials: "JH", color: "#CD5C5C" },
            { name: "Kimberly Seldon", location: "Lancaster, TX", initials: "KS", color: "#4B0082" },
            { name: "Dianna Rosenthal", location: "Richardson, TX", initials: "DR", color: "#F0E68C" },
            { name: "Julie Jones", location: "San Antonio, TX", initials: "JJ", color: "#E6E6FA" },
            { name: "Justin Harn", location: "King City, CA", initials: "JH", color: "#FFF0F5" },
            { name: "Melissa Sauer", location: "Plymouth, MI", initials: "MS", color: "#7CFC00" },
            { name: "Malia Lazu", location: "Boston, MA", initials: "ML", color: "#FFFACD" },
            { name: "Kelsey Kornblatt", location: "Arlington, VA", initials: "KK", color: "#ADD8E6" },
            { name: "Dave Stroud", location: "Aurora, CO", initials: "DS", color: "#F08080" },
            { name: "Cory Fleming", location: "Rowlett, TX", initials: "CF", color: "#FAFAD2" },
            { name: "Colin Watson", location: "West Melbourne, FL", initials: "CW", color: "#90EE90" },
            { name: "Erik Schulz", location: "Wenatchee, WA", initials: "ES", color: "#FFB6C1" },
            { name: "Chante Young", location: "Houston, TX", initials: "CY", color: "#FFA07A" },
            { name: "Kelly Pierce", location: "Downers Grove, IL", initials: "KP", color: "#20B2AA" },
            { name: "Colby Brusnahan", location: "Wellington, FL", initials: "CB", color: "#87CEFA" },
            { name: "Jason Morado", location: "Austin, TX", initials: "JM", color: "#778899" },
            { name: "Brianna Govoni", location: "Cambridge, MA", initials: "BG", color: "#B0C4DE" },
            { name: "Jeffrey Jones", location: "Kansas City, MO", initials: "JJ", color: "#FFFFE0" },
            { name: "Haley Bracewell", location: "Cibolo, TX", initials: "HB", color: "#00FF00" },
            { name: "Kathryn Gauthier", location: "Austin, TX", initials: "KG", color: "#32CD32" },
            { name: "Ariel Turner", location: "Buda, TX", initials: "AT", color: "#FAF0E6" },
            { name: "Shawn Portillo", location: "Somerville, MA", initials: "SP", color: "#FF00FF" },
            { name: "Leah Quinn", location: "Arvada, CO", initials: "LQ", color: "#800000" },
            { name: "Kiri Sweeney", location: "Beaverton, OR", initials: "KS", color: "#66CDAA" },
            { name: "Brittany Bennett", location: "Grand Rapids, MI", initials: "BB", color: "#0000CD" },
            { name: "Jim Fargher", location: "Evanston, IL", initials: "JF", color: "#BA55D3" },
            { name: "Daniel Valdez", location: "Leander, TX", initials: "DV", color: "#9370DB" },
            { name: "Tobi Conley", location: "Seattle, WA", initials: "TC", color: "#3CB371" },
            { name: "Brian Rimsza", location: "Phoenix, AZ", initials: "BR", color: "#7B68EE" },
            { name: "Michael Valdivia", location: "Salinas, CA", initials: "MV", color: "#00FA9A" },
            { name: "Bridget Hylton", location: "Chesterfield County, VA", initials: "BH", color: "#48D1CC" },
            { name: "Chelsea Lee", location: "Parkland, FL", initials: "CL", color: "#C71585" },
            { name: "Stephanie Chase", location: "Sunnyvale, CA", initials: "SC", color: "#191970" },
            { name: "Patrick Malone", location: "Jefferson County, CO", initials: "PM", color: "#FF7F50" },
            { name: "Katie Harger", location: "Boise, ID", initials: "KH", color: "#FF4500" },
            { name: "Charles Alexander", location: "Charlotte, NC", initials: "CA", color: "#FFA500" },
            { name: "Eric Peterson", location: "Coral Springs, FL", initials: "EP", color: "#FFD700" },
            { name: "Stephanie McElroy", location: "Ypsilanti, MI", initials: "SM", color: "#DA70D6" }
        ];

        const specialCities = {
            // Tyler Major Offices - 50 points
            'plano': { type: 'tyler-major', points: 50, lat: 33.0198, lng: -96.6989 },
            'yarmouth': { type: 'tyler-major', points: 50, lat: 43.8007, lng: -70.1870 },
            
            // Tyler Offices - 10 points
            'austin': { type: 'tyler', points: 10, lat: 30.2672, lng: -97.7431 },
            'dallas': { type: 'tyler', points: 10, lat: 32.7767, lng: -96.7970 },
            'detroit': { type: 'tyler', points: 10, lat: 42.3314, lng: -83.0458 },
            'lubbock': { type: 'tyler', points: 10, lat: 33.5779, lng: -101.8552 },
            'kansas city': { type: 'tyler', points: 10, lat: 39.0997, lng: -94.5786 },
            'denver': { type: 'tyler', points: 10, lat: 39.7392, lng: -104.9903 },
            'salem': { type: 'tyler', points: 10, lat: 44.9429, lng: -123.0351 },
            'olympia': { type: 'tyler', points: 10, lat: 47.0379, lng: -122.9007 },
            'atlanta': { type: 'tyler', points: 10, lat: 33.7490, lng: -84.3880 },
            'columbus': { type: 'tyler', points: 10, lat: 39.9612, lng: -82.9988 },
            'philadelphia': { type: 'tyler', points: 10, lat: 39.9526, lng: -75.1652 },
            'albany': { type: 'tyler', points: 10, lat: 42.6526, lng: -73.7562 },
            
            // Priority Based Budgeting Cities - 25 points
            'boulder': { type: 'pbb', points: 25, lat: 40.0150, lng: -105.2705 },
            'fort collins': { type: 'pbb', points: 25, lat: 40.5853, lng: -105.0844 },
            'lakewood': { type: 'pbb', points: 25, lat: 39.7047, lng: -105.0814 },
            'westminster': { type: 'pbb', points: 25, lat: 39.8361, lng: -105.0372 },
            'arvada': { type: 'pbb', points: 25, lat: 39.8028, lng: -105.0875 },
            'thornton': { type: 'pbb', points: 25, lat: 39.8680, lng: -104.9719 },
            'portland': { type: 'pbb', points: 25, lat: 45.5152, lng: -122.6784 },
            'eugene': { type: 'pbb', points: 25, lat: 44.0521, lng: -123.0868 },
            'gresham': { type: 'pbb', points: 25, lat: 45.4983, lng: -122.4302 },
            'san antonio': { type: 'pbb', points: 25, lat: 29.4241, lng: -98.4936 },
            'cincinnati': { type: 'pbb', points: 25, lat: 39.1031, lng: -84.5120 },
            'pittsburgh': { type: 'pbb', points: 25, lat: 40.4406, lng: -79.9959 },
            'reno': { type: 'pbb', points: 25, lat: 39.5296, lng: -119.8138 },
            'henderson': { type: 'pbb', points: 25, lat: 36.0395, lng: -114.9817 },
            'chandler': { type: 'pbb', points: 25, lat: 33.3062, lng: -111.8413 },
            'mesa': { type: 'pbb', points: 25, lat: 33.4152, lng: -111.8315 },
            'scottsdale': { type: 'pbb', points: 25, lat: 33.4942, lng: -111.9261 }
        };

        // Load Google Maps API dynamically and securely
        async function loadGoogleMapsAPI() {
            try {
                console.log('Fetching Google Maps API key...');
                // Fetch the API key from the server
                const response = await fetch('/api/google-maps-key');
                const data = await response.json();
                
                console.log('API key response:', data);
                
                if (data.key && data.key !== 'YOUR_API_KEY_PLACEHOLDER' && data.key !== '') {
                    console.log('Loading Google Maps with API key...');
                    // Create and load the Google Maps script
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${data.key}&libraries=places&callback=initMap`;
                    script.async = true;
                    script.defer = true;
                    script.onerror = function() {
                        console.error('Failed to load Google Maps script');
                        gameState.googleMapsLoaded = false;
                        // Show game without map
                        document.getElementById('googleMap').innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100%; background: #87CEEB; color: #2c3e50; font-family: Orbitron, sans-serif; font-size: 18px;">Map loading... Game still playable!</div>';
                    };
                    document.head.appendChild(script);
                } else {
                    console.warn('Google Maps API key not configured on server');
                    gameState.googleMapsLoaded = false;
                    // Show game without map but still playable
                    document.getElementById('googleMap').innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100%; background: linear-gradient(135deg, #87CEEB 0%, #98D8C8 100%); color: #2c3e50; font-family: Orbitron, sans-serif; font-size: 18px; text-align: center; padding: 20px;"><div><h2 style="font-family: Press Start 2P, cursive; margin-bottom: 20px;">Map Unavailable</h2><p>But the game still works! Search for cities to take selfies!</p></div></div>';
                }
            } catch (error) {
                console.error('Failed to fetch API key:', error);
                gameState.googleMapsLoaded = false;
                // Show game without map
                document.getElementById('googleMap').innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100%; background: linear-gradient(135deg, #87CEEB 0%, #98D8C8 100%); color: #2c3e50; font-family: Orbitron, sans-serif; font-size: 18px;">Game ready! Search for cities!</div>';
            }
        }

        // Initialize Google Map
        function initMap() {
            console.log('Initializing Google Map...');
            gameState.googleMapsLoaded = true;
            gameState.map = new google.maps.Map(document.getElementById('googleMap'), {
                zoom: 3,
                center: { lat: 39.8283, lng: -98.5795 }, // Center of USA
                styles: [
                    {
                        featureType: "all",
                        elementType: "geometry",
                        stylers: [{ color: "#6B8E23" }]
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#4682B4" }]
                    },
                    {
                        featureType: "road",
                        elementType: "geometry",
                        stylers: [{ color: "#8B7355" }]
                    },
                    {
                        featureType: "poi.park",
                        elementType: "geometry",
                        stylers: [{ color: "#228B22" }]
                    }
                ]
            });

            gameState.geocoder = new google.maps.Geocoder();
            gameState.placesService = new google.maps.places.PlacesService(gameState.map);
            
            // Wait for map to be fully loaded, then spawn pins
            google.maps.event.addListenerOnce(gameState.map, 'idle', function() {
                console.log('Map is ready, spawning pins...');
                spawnInfluencers();
            });
        }

        // Make initMap globally accessible for Google Maps callback
        window.initMap = initMap;

        // Photo Upload Handler
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    gameState.playerPhoto = e.target.result;
                    document.getElementById('photoLabel').innerHTML = 'âœ… PHOTO READY';
                    document.getElementById('startBtn').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        // Start Game
        async function startGame(event) {
            event.preventDefault();
            
            gameState.playerName = document.getElementById('playerName').value;
            gameState.playerEmail = document.getElementById('playerEmail').value;
            
            if (!gameState.playerPhoto) {
                alert('Please upload your photo!');
                return;
            }

            // Register player
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: gameState.playerName,
                        email: gameState.playerEmail,
                        photo: gameState.playerPhoto
                    })
                });
                
                const data = await response.json();
                gameState.playerId = data.player.id;
            } catch (error) {
                console.error('Registration failed:', error);
                gameState.playerId = 'offline_' + Date.now();
            }

            // Set avatar photo
            document.getElementById('avatarHead').style.backgroundImage = `url(${gameState.playerPhoto})`;
            document.getElementById('selfiePersonHead').style.backgroundImage = `url(${gameState.playerPhoto})`;
            
            // Start game
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            
            // Play background music
            document.getElementById('bgMusic').play().catch(e => console.log('Audio autoplay blocked'));
            
            // Load leaderboard
            updateLeaderboard();
            
            // Spawn some influencers on the map!
            spawnInfluencers();
            
            // Load community selfies
            loadCommunitySelfies();
            
            // Position avatar at center of map
            if (gameState.googleMapsLoaded && gameState.map) {
                // Make sure avatar is visible
                const avatar = document.getElementById('avatar');
                avatar.style.display = 'block';
                avatar.style.top = '50%';
                avatar.style.left = '50%';
                avatar.style.transform = 'translate(-50%, -50%)';
                
                // Position on map coordinates
                setTimeout(() => {
                    positionAvatar(39.8283, -98.5795);
                }, 500);
            } else {
                // Even without map, show avatar
                const avatar = document.getElementById('avatar');
                avatar.style.display = 'block';
                avatar.style.top = '50%';
                avatar.style.left = '50%';
            }
        }

        // Spawn ELGL Influencers on the map
        function spawnInfluencers() {
            console.log('Spawning ELGL Influencers...');
            const mapDiv = document.getElementById('googleMap');
            
            // Make sure we have a map div
            if (!mapDiv) {
                console.error('Map div not found!');
                return;
            }
            
            // Spawn 10-15 influencers immediately
            const numInfluencers = 10 + Math.floor(Math.random() * 6);
            console.log(`Spawning ${numInfluencers} influencers`);
            
            const shuffled = [...elglInfluencers].sort(() => 0.5 - Math.random());
            const selectedInfluencers = shuffled.slice(0, numInfluencers);
            
            selectedInfluencers.forEach((influencer, index) => {
                // Spawn immediately, no delay
                const avatar = createInfluencerAvatar(influencer);
                mapDiv.appendChild(avatar);
                gameState.influencersOnMap.push({
                    element: avatar,
                    data: influencer
                });
                console.log(`Spawned ${influencer.name} at position`, avatar.style.left, avatar.style.top);
            });
            
            // Spawn new influencers every 20 seconds
            setInterval(() => {
                if (gameState.influencersOnMap.length < 20 && document.getElementById('gameContainer').style.display === 'block') {
                    const remaining = elglInfluencers.filter(inf => 
                        !gameState.influencersFound.includes(inf.name) &&
                        !gameState.influencersOnMap.some(m => m.data.name === inf.name)
                    );
                    if (remaining.length > 0) {
                        const newInfluencer = remaining[Math.floor(Math.random() * remaining.length)];
                        const avatar = createInfluencerAvatar(newInfluencer);
                        mapDiv.appendChild(avatar);
                        gameState.influencersOnMap.push({
                            element: avatar,
                            data: newInfluencer
                        });
                        console.log(`New influencer spawned: ${newInfluencer.name}`);
                    }
                }
            }, 20000);
        }

        // Create an influencer avatar - make them bigger and more visible
        function createInfluencerAvatar(influencer) {
            const avatar = document.createElement('div');
            avatar.className = 'influencer-avatar';
            
            // Position them randomly but visible
            const leftPos = 10 + Math.random() * 80;
            const topPos = 10 + Math.random() * 80;
            avatar.style.left = leftPos + '%';
            avatar.style.top = topPos + '%';
            avatar.style.position = 'absolute';
            avatar.style.zIndex = '75'; // Make sure they're above the map
            
            const head = document.createElement('div');
            head.className = 'influencer-head';
            head.style.background = influencer.color || '#FF6B6B';
            head.textContent = influencer.initials;
            head.title = influencer.name + ' from ' + influencer.location; // Tooltip
            
            const body = document.createElement('div');
            body.className = 'influencer-body';
            
            avatar.appendChild(head);
            avatar.appendChild(body);
            
            // Make them more interactive
            avatar.style.cursor = 'pointer';
            avatar.onclick = () => findInfluencer(influencer, avatar);
            
            // Add hover effect
            avatar.onmouseover = () => {
                avatar.style.transform = 'scale(1.3)';
                avatar.style.zIndex = '100';
            };
            avatar.onmouseout = () => {
                avatar.style.transform = 'scale(1)';
                avatar.style.zIndex = '75';
            };
            
            // Random movement with bounds checking
            moveInfluencerRandomly(avatar);
            
            return avatar;
        }

        // Move influencer randomly around the map - improved movement
        function moveInfluencerRandomly(avatar) {
            const moveInfluencer = () => {
                const currentLeft = parseFloat(avatar.style.left);
                const currentTop = parseFloat(avatar.style.top);
                
                // Move within bounds
                const moveX = (Math.random() - 0.5) * 20;
                const moveY = (Math.random() - 0.5) * 20;
                
                const newLeft = Math.max(5, Math.min(85, currentLeft + moveX));
                const newTop = Math.max(5, Math.min(85, currentTop + moveY));
                
                // Smooth transition
                avatar.style.transition = 'left 3s ease, top 3s ease';
                avatar.style.left = newLeft + '%';
                avatar.style.top = newTop + '%';
            };
            
            // Initial movement
            setTimeout(moveInfluencer, 1000);
            
            // Continue moving
            setInterval(moveInfluencer, 5000 + Math.random() * 5000);
        }

        // Find an influencer
        function findInfluencer(influencer, avatarElement) {
            if (gameState.influencersFound.includes(influencer.name)) {
                alert('You already found ' + influencer.name + '!');
                return;
            }
            
            // Add to found list
            gameState.influencersFound.push(influencer.name);
            
            // Update counter
            document.getElementById('influencerCount').textContent = gameState.influencersFound.length;
            
            // Add points
            const points = 15; // 15 points for finding an influencer
            gameState.score += points;
            document.getElementById('scoreValue').textContent = gameState.score;
            
            // Show animation
            showPointsAnimation(points);
            
            // Remove from map
            avatarElement.style.animation = 'bounceOut 0.5s ease forwards';
            setTimeout(() => {
                avatarElement.remove();
                gameState.influencersOnMap = gameState.influencersOnMap.filter(m => m.element !== avatarElement);
            }, 500);
            
            // Show modal
            document.getElementById('influencerName').textContent = influencer.name;
            document.getElementById('influencerLocation').textContent = influencer.location;
            document.getElementById('influencerModal').classList.add('show');
            
            // Update server
            try {
                fetch('/api/score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        playerId: gameState.playerId,
                        points: points,
                        location: 'Found ' + influencer.name
                    })
                });
                updateLeaderboard();
            } catch (error) {
                console.error('Score update failed:', error);
            }
            
            // Special celebration if all found
            if (gameState.influencersFound.length === elglInfluencers.length) {
                setTimeout(() => {
                    alert('ðŸŽ‰ INCREDIBLE! You found ALL 105 ELGL Influencers! +500 BONUS POINTS! ðŸŽ‰');
                    gameState.score += 500;
                    document.getElementById('scoreValue').textContent = gameState.score;
                    createMegaConfetti();
                }, 1000);
            }
        }

        // Close influencer modal
        function closeInfluencerModal() {
            document.getElementById('influencerModal').classList.remove('show');
            createConfetti();
        }

        // Create mega confetti for finding all influencers
        function createMegaConfetti() {
            const colors = ['#f1c40f', '#e74c3c', '#3498db', '#27ae60', '#9b59b6', '#e67e22', '#1abc9c'];
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.position = 'fixed';
                    confetti.style.width = '15px';
                    confetti.style.height = '15px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = '-15px';
                    confetti.style.zIndex = '3000';
                    confetti.style.borderRadius = '50%';
                    confetti.style.animation = 'fall 4s linear forwards';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 20);
            }
        }

        // Search for location
        async function searchLocation() {
            const searchInput = document.getElementById('locationSearch').value.trim();
            if (!searchInput) {
                alert('Please enter a city name!');
                return;
            }

            // Show loading
            showLoading();

            // Check if it's a special city
            const cityLower = searchInput.toLowerCase();
            const specialCity = specialCities[cityLower];

            if (gameState.googleMapsLoaded && gameState.geocoder) {
                // Geocode the location
                gameState.geocoder.geocode({ address: searchInput }, async (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        const lat = location.lat();
                        const lng = location.lng();
                        
                        // Store current city info
                        gameState.currentCity = {
                            name: results[0].formatted_address,
                            lat: lat,
                            lng: lng,
                            type: specialCity ? specialCity.type : 'regular',
                            points: specialCity ? specialCity.points : 5
                        };

                        // Move map to location
                        gameState.map.setCenter(location);
                        gameState.map.setZoom(15);

                        // Add marker
                        const marker = new google.maps.Marker({
                            position: location,
                            map: gameState.map,
                            icon: {
                                url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIGZpbGw9IiNlNzRjM2MiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPHRleHQgeD0iMjAiIHk9IjI4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjI0Ij7wn4+bPC90ZXh0Pgo8L3N2Zz4=',
                                scaledSize: new google.maps.Size(40, 40)
                            },
                            animation: google.maps.Animation.DROP
                        });

                        gameState.markers.push(marker);

                        // Animate avatar to location
                        await animateAvatarToLocation(lat, lng);

                        // Search for city hall image
                        await searchCityHallImage(searchInput);

                        hideLoading();

                        // Show selfie modal
                        setTimeout(() => showSelfieModal(), 500);

                    } else {
                        hideLoading();
                        alert('Could not find that city. Try another name!');
                    }
                });
            } else {
                // Fallback without Google Maps
                gameState.currentCity = {
                    name: searchInput,
                    type: specialCity ? specialCity.type : 'regular',
                    points: specialCity ? specialCity.points : 5
                };
                
                await searchCityHallImage(searchInput);
                hideLoading();
                showSelfieModal();
            }

            document.getElementById('locationSearch').value = '';
        }

        // Search for City Hall Image - Enhanced with multiple services
        async function searchCityHallImage(cityName) {
            try {
                // Try multiple image sources for real city hall photos
                if (gameState.googleMapsLoaded && gameState.placesService) {
                    // Search for city hall using Places API with more specific queries
                    const searchQueries = [
                        `${cityName} city hall`,
                        `${cityName} town hall`,
                        `${cityName} municipal building`,
                        `${cityName} government center`,
                        `${cityName} civic center`,
                        `${cityName} county administration building`
                    ];
                    
                    let photoFound = false;
                    
                    // Try each query until we find a photo
                    for (const query of searchQueries) {
                        if (photoFound) break;
                        
                        await new Promise((resolve) => {
                            const request = {
                                query: query,
                                fields: ['photos', 'name', 'formatted_address', 'types']
                            };
                            
                            gameState.placesService.findPlaceFromQuery(request, (results, status) => {
                                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                                    // Filter for actual government buildings
                                    const govBuilding = results.find(place => {
                                        if (!place.types) return false;
                                        const govTypes = ['city_hall', 'local_government_office', 'courthouse', 'town_hall'];
                                        return place.types.some(type => govTypes.includes(type));
                                    }) || results[0];
                                    
                                    if (govBuilding && govBuilding.photos && govBuilding.photos.length > 0) {
                                        const photoUrl = govBuilding.photos[0].getUrl({
                                            maxWidth: 600,
                                            maxHeight: 400
                                        });
                                        document.getElementById('selfieBackground').style.backgroundImage = `url(${photoUrl})`;
                                        photoFound = true;
                                    }
                                }
                                resolve();
                            });
                        });
                    }
                    
                    if (!photoFound) {
                        // If no photo found via Places API, use curated fallback
                        useCuratedCityHallImage(cityName);
                    }
                } else {
                    // Use fallback image service
                    useCuratedCityHallImage(cityName);
                }
                
            } catch (error) {
                console.error('Image search failed:', error);
                useCuratedCityHallImage(cityName);
            }
        }
        
        // Curated city hall images for special cities
        function useCuratedCityHallImage(cityName) {
            const cityLower = cityName.toLowerCase();
            
            // Curated images for cities where Google Places might not work well
            const curatedImages = {
                'yarmouth': 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8e/Yarmouth_Town_Hall%2C_Maine.jpg/800px-Yarmouth_Town_Hall%2C_Maine.jpg',
                'plano': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Plano_Municipal_Center.jpg/800px-Plano_Municipal_Center.jpg',
                'denver': 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/35/Denver_City_and_County_Building.JPG/800px-Denver_City_and_County_Building.JPG',
                'thornton': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/94/Thornton_City_Hall.jpg/800px-Thornton_City_Hall.jpg'
            };
            
            if (curatedImages[cityLower]) {
                // Use curated image
                const img = new Image();
                img.onload = function() {
                    document.getElementById('selfieBackground').style.backgroundImage = `url(${img.src})`;
                };
                img.onerror = function() {
                    // If curated image fails, use generic fallback
                    useFallbackImage(cityName);
                };
                img.src = curatedImages[cityLower];
            } else {
                // Use generic search fallback
                useFallbackImage(cityName);
            }
        }
        
        // Fallback image function
        function useFallbackImage(cityName) {
            // Try multiple image sources with more specific queries
            const imageUrls = [
                `https://source.unsplash.com/600x400/?${encodeURIComponent(cityName)}-city-hall,government-building,municipal`,
                `https://source.unsplash.com/600x400/?city-hall,${encodeURIComponent(cityName)},civic-center`,
                `https://source.unsplash.com/600x400/?government-building,${encodeURIComponent(cityName)}`,
                `https://loremflickr.com/600/400/cityhall,government,${encodeURIComponent(cityName)}/all`
            ];
            
            // Try to load the first working image
            const img = new Image();
            let currentIndex = 0;
            
            function tryNextImage() {
                if (currentIndex < imageUrls.length) {
                    img.src = imageUrls[currentIndex];
                    currentIndex++;
                } else {
                    // Use default generic city hall if all fail
                    document.getElementById('selfieBackground').style.backgroundImage = 
                        'url(https://upload.wikimedia.org/wikipedia/commons/thumb/2/2b/US-Government-Capitol.jpg/800px-US-Government-Capitol.jpg)';
                }
            }
            
            img.onload = function() {
                document.getElementById('selfieBackground').style.backgroundImage = `url(${img.src})`;
            };
            
            img.onerror = function() {
                tryNextImage();
            };
            
            tryNextImage();
        }

        // Animate Avatar to Location
        async function animateAvatarToLocation(lat, lng) {
            return new Promise(resolve => {
                const avatar = document.getElementById('avatar');
                avatar.classList.add('walking');
                
                // Position avatar on map
                if (gameState.googleMapsLoaded) {
                    positionAvatar(lat, lng);
                }
                
                setTimeout(() => {
                    avatar.classList.remove('walking');
                    resolve();
                }, 2000);
            });
        }

        // Position Avatar on Map
        function positionAvatar(lat, lng) {
            if (!gameState.map) return;
            
            const projection = gameState.map.getProjection();
            if (!projection) {
                // If projection not ready, try again
                setTimeout(() => positionAvatar(lat, lng), 100);
                return;
            }
            
            const point = projection.fromLatLngToPoint(new google.maps.LatLng(lat, lng));
            const scale = Math.pow(2, gameState.map.getZoom());
            
            const worldPoint = new google.maps.Point(point.x * scale, point.y * scale);
            const centerPoint = projection.fromLatLngToPoint(gameState.map.getCenter());
            const centerWorld = new google.maps.Point(centerPoint.x * scale, centerPoint.y * scale);
            
            const mapDiv = document.getElementById('googleMap');
            const pixelX = (worldPoint.x - centerWorld.x) + mapDiv.offsetWidth / 2;
            const pixelY = (worldPoint.y - centerWorld.y) + mapDiv.offsetHeight / 2;
            
            const avatar = document.getElementById('avatar');
            avatar.style.left = pixelX + 'px';
            avatar.style.top = pixelY + 'px';
        }

        // Show Selfie Modal
        function showSelfieModal() {
            const modal = document.getElementById('selfieModal');
            const locationName = document.getElementById('locationName');
            
            locationName.innerHTML = `ðŸ“ ${gameState.currentCity.name}`;
            
            // Add special location badges
            if (gameState.currentCity.type === 'tyler-major') {
                locationName.innerHTML += '<br><span style="color: #0066CC; font-size: 14px;">ðŸ¢ Tyler Technologies HQ! (+50 pts)</span>';
            } else if (gameState.currentCity.type === 'tyler') {
                locationName.innerHTML += '<br><span style="color: #0066CC; font-size: 14px;">ðŸ¢ Tyler Office (+10 pts)</span>';
            } else if (gameState.currentCity.type === 'pbb') {
                locationName.innerHTML += '<br><span style="color: #e74c3c; font-size: 14px;">ðŸ’° Priority Based Budgeting City! (+25 pts)</span>';
            }
            
            modal.classList.add('show');
        }

        // Take Selfie
        async function takeSelfie() {
            const city = gameState.currentCity;
            let points = city.points;
            
            // Show points animation
            showPointsAnimation(points);
            
            // Update score
            gameState.score += points;
            document.getElementById('scoreValue').textContent = gameState.score;
            
            // Add logos if special location
            if (city.type === 'tyler' || city.type === 'tyler-major') {
                addLogo('tyler', 'TYLER');
            }
            if (city.type === 'pbb') {
                addLogo('resourcex', 'RX');
            }
            
            // Update server
            try {
                await fetch('/api/score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        playerId: gameState.playerId,
                        points: points,
                        location: city.name
                    })
                });
                
                updateLeaderboard();
            } catch (error) {
                console.error('Score update failed:', error);
            }
            
            closeSelfieModal();
            createConfetti();
        }

        // Show Points Animation
        function showPointsAnimation(points) {
            const mapDiv = document.getElementById('googleMap');
            const avatar = document.getElementById('avatar');
            const popup = document.createElement('div');
            popup.className = 'points-popup';
            popup.textContent = `+${points}`;
            popup.style.left = avatar.style.left;
            popup.style.top = avatar.style.top;
            
            mapDiv.appendChild(popup);
            
            setTimeout(() => popup.remove(), 2000);
        }

        // Add Logo
        function addLogo(type, text) {
            const logoQueue = document.getElementById('logoQueue');
            const logo = document.createElement('div');
            logo.className = `logo-item ${type}`;
            logo.textContent = text;
            logoQueue.appendChild(logo);
            
            setTimeout(() => logo.remove(), 10000);
        }

        // Create Confetti
        function createConfetti() {
            const colors = ['#f1c40f', '#e74c3c', '#3498db', '#27ae60', '#9b59b6'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.position = 'fixed';
                    confetti.style.width = '10px';
                    confetti.style.height = '10px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = '-10px';
                    confetti.style.zIndex = '3000';
                    confetti.style.borderRadius = '50%';
                    confetti.style.animation = 'fall 3s linear forwards';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        // Update Leaderboard
        async function updateLeaderboard() {
            try {
                const response = await fetch('/api/leaderboard');
                const leaderboard = await response.json();
                
                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = '';
                
                leaderboard.slice(0, 20).forEach((player, index) => {
                    const entry = document.createElement('div');
                    entry.className = 'leaderboard-entry';
                    if (index === 0) entry.classList.add('gold');
                    if (index === 1) entry.classList.add('silver');
                    if (index === 2) entry.classList.add('bronze');
                    
                    entry.innerHTML = `
                        <span class="rank">${index + 1}</span>
                        <span class="player-name">${player.name}</span>
                        <span class="player-score">${player.score}</span>
                    `;
                    
                    leaderboardList.appendChild(entry);
                });
                
                if (leaderboard.length === 0) {
                    leaderboardList.innerHTML = '<div class="leaderboard-entry"><span class="player-name">Be the first!</span></div>';
                }
            } catch (error) {
                console.error('Leaderboard update failed:', error);
            }
        }

        // Share to LinkedIn
        function shareToLinkedIn() {
            const text = `ðŸ›ï¸ I scored ${gameState.score} points in the City Hall Selfie Game for ELGL's 10th Anniversary City Hall Selfie Day! Can you beat my score? #CityHallSelfie #ELGL #LocalGov #August12`;
            const url = window.location.href;
            
            const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
            window.open(linkedinUrl, '_blank', 'width=600,height=400');
        }

        // Close Selfie Modal
        function closeSelfieModal() {
            document.getElementById('selfieModal').classList.remove('show');
        }

        // Show/Hide Loading
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // My Selfies Gallery Functions
        function showMySelfies() {
            const gallery = document.getElementById('selfiesGallery');
            const grid = document.getElementById('selfiesGrid');
            
            // Clear existing content
            grid.innerHTML = '';
            
            if (gameState.mySelfies.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #7f8c8d;">No selfies yet! Start exploring cities to take your first selfie!</div>';
            } else {
                gameState.mySelfies.forEach(selfie => {
                    const item = document.createElement('div');
                    item.className = 'selfie-item';
                    item.innerHTML = `
                        <img src="${selfie.image}" alt="Selfie at ${selfie.location}">
                        <div class="selfie-item-info">
                            ${selfie.location}<br>
                            <small>${selfie.date}</small>
                        </div>
                    `;
                    grid.appendChild(item);
                });
            }
            
            gallery.classList.add('show');
        }

        function closeSelfiesGallery() {
            document.getElementById('selfiesGallery').classList.remove('show');
        }

        // Load community selfies (placeholder function)
        function loadCommunitySelfies() {
            // This would load from server in a real implementation
            gameState.communitySelfies = [];
        }

        // Toggle instructions (placeholder function)
        function toggleInstructions() {
            const panel = document.getElementById('instructionsPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            // Load Google Maps API securely
            loadGoogleMapsAPI();
            
            // Mobile touch handling
            if ('ontouchstart' in window) {
                document.addEventListener('touchmove', function(e) {
                    // Allow scrolling on specific elements
                    if (e.target.closest('.start-container') || 
                        e.target.closest('.selfies-gallery-modal') ||
                        e.target.closest('.gallery-content') ||
                        e.target.closest('.leaderboard') ||
                        e.target.closest('#googleMap')) {
                        return;
                    }
                    // Prevent default scrolling on other elements
                    if (e.target.closest('#gameContainer')) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // Fix iOS viewport height
                const setVH = () => {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                };
                setVH();
                window.addEventListener('resize', setVH);
                window.addEventListener('orientationchange', setVH);
            }
        });

        // Auto-refresh leaderboard
        setInterval(() => {
            if (document.getElementById('gameContainer').style.display === 'block') {
                updateLeaderboard();
            }
        }, 30000);

        // Handle enter key in search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('locationSearch');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchLocation();
                    }
                });
            }
        });
    </script>
</body>
</html>